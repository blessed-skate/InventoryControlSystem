package mx.com.icsp.util.pdf;

import java.io.IOException;
import java.io.InputStream;
import java.io.OutputStream;
import java.net.URL;
import java.util.ArrayList;
import java.util.Collection;
import java.util.Date;
import java.util.HashMap;
import java.util.List;
import java.util.Map;

import javax.servlet.http.HttpServletResponse;
import javax.swing.ImageIcon;

import mx.com.icsc.common.Asset;
import mx.com.icsc.common.util.LogPattern;
import mx.com.icsp.util.Constants;
import net.sf.jasperreports.engine.JRException;
import net.sf.jasperreports.engine.JasperCompileManager;
import net.sf.jasperreports.engine.JasperExportManager;
import net.sf.jasperreports.engine.JasperFillManager;
import net.sf.jasperreports.engine.JasperPrint;
import net.sf.jasperreports.engine.JasperReport;
import net.sf.jasperreports.engine.data.JRBeanCollectionDataSource;

import org.apache.commons.lang.builder.ToStringBuilder;
import org.apache.log4j.Logger;

public class PdfReport {

	private Logger log = Logger.getLogger(this.getClass());
	private LogPattern logPattern = new LogPattern(Constants.domainCode,
			Constants.solutioNameCode, Constants.platform, Constants.tower,
			this.getClass().getName());

	public void generate(String idTransaction, HttpServletResponse response,
			String fileName, List<Asset> arrayList) {

		String methodName = new Throwable().getStackTrace()[0].getMethodName();

		try {
			Map<String, Object> parameters = new HashMap<String, Object>();
			JRBeanCollectionDataSource dataSource;
			dataSource = new JRBeanCollectionDataSource(arrayList);
			
			URL url = null;
			try{
				url = this.getClass().getResource("logo2.png");
				log.info(logPattern.buildPattern(methodName, idTransaction, "url", ToStringBuilder.reflectionToString(url)));
				ImageIcon img = new ImageIcon(url.getPath());
				parameters.put("image", img.getImage());
			}catch(Exception e){
				log.error(logPattern.buildPattern(methodName, idTransaction,
						"Exception", e.getMessage()), e);
			}

			// Datos de la cuenta
			parameters.put("cuenta", "5.12357");
			parameters.put("factura", "144422");
			parameters.put("fecha_emision", "hoy");
			parameters.put("lugar_emision", "Puebla");
			parameters.put("rfc", "ROAH860109");

			// Direccion del cliente
			parameters.put("linea1", "Camino real a momoxpan");
			parameters.put("linea2", "no. 2424 int. 47");
			parameters.put("linea3", "Residencial San Pedro");
			parameters.put("linea4", "San Pedro Cholula");
			parameters.put("linea5", "Puebla");
			parameters.put("linea6", "C.P. 72760");

			parameters.put("subtotal", "212");
			parameters.put("iva", "12121");
			parameters.put("ivaPorcentaje", "16%");
			parameters.put("total", "21.22");
			parameters
					.put("totalLetra",
							"**********************CIENTO DIECISEIS PESOS 00/100 M.N.**********************");

			parameters.put("fecha_aut", "hoy");
			parameters.put("num_aprobacion", "323");

			parameters
					.put("sello",
							"RLm49gNyrkjwgui0oOt+vcUEyBLpXdRIkRCB8W7xkek6pRd6Zu3TzmQ73fVRy0eU4HNRGCI5N205zTAWq7MKpnEOZZ1BkrQHTFXO2JMmq+DWl0ADCvqMJZdE88X9vHUalPdityEOwwxRBFLSbvKyJ4RZ06Ayl7xtiftNEJ8D07k=");
			parameters
					.put("cadena_original",
							"||2.0|AAD|30|2010-04-06T09:57:35|53190|2010|ingreso|Pago en una sola exhibicion|CONTADO|100|116|IUS890616RH6|IUSACELL S.A. DE C.V|MONTES URALES|460|LOMAS DE CHAPULTEPEC|DISTRITOFEDERAL|MIGUEL HIDALGO|D.F|MEXICO|11000|RVE0210179M5|REAL DE VENTAS, S.A. DE C.V.|88630 REYNOSA TAMAULIPAS|0000|BETY|88630 REYNOSA TAMAULIPAS|88630 REYNOSA TAMAULIPAS|MEXICO|88630|1|NOTIENE|100|100|IVA|16|16.00|INTERFACTURA SAPI DE CV|INT020124V62|00001000000001991954|2007-08-02T18:00:00|74592||");
			parameters.put("certificado", "00001100000200000154");

			InputStream inputStream = this.getClass().getResourceAsStream("report3.jrxml");
			JasperReport report;
			report = JasperCompileManager.compileReport(inputStream);

			JasperPrint print = JasperFillManager.fillReport(report, parameters, dataSource);
			fileName = fileName.toLowerCase().contains(".pdf") ? fileName : fileName + ".pdf";

			response.setContentType("application/x-pdf");
			response.setHeader("Content-Disposition", "attachment; filename="+fileName);// set HTTP/1.0 no-cache

			OutputStream outStream;
			outStream = response.getOutputStream();

			JasperExportManager.exportReportToPdfStream(print, outStream);

		} catch (JRException e) {
			log.error(logPattern.buildPattern(methodName, idTransaction,
					"JRException", e.getMessage()), e);
		} catch (IOException e) {
			log.error(logPattern.buildPattern(methodName, idTransaction,
					"IOException", e.getMessage()), e);
		}

	}
	
	public void generateGuard(String idTransaction, HttpServletResponse response,
			String fileName, List<Asset> arrayList) {
		
	}
}
